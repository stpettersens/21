/*
Blackjack (enchant.js build).
Copyright 2015 Sam Saint-Pettersen
Released under the MIT/X11 License.
https://github.com/stpettersens/21
*/
function SoundEffects(){}function Debug(){}function Cards(){this.index=-1,this.deck_num=52,this.deck=[],this.played=[],this.ranks=["A",2,3,4,5,6,7,8,9,10,"J","Q","K"],this.suits=["h","d","c","s"]}function Card(e,t,r,s){this.sprite=new Sprite(71,96),this.sprite.image=s.assets[e],this.sprite.x=t,this.sprite.y=r,this.src=e}function Screentip(e,t,r){this.title=new Label(""),this.msg=new Label(""),this.title.color="rgb(255, 255, 255)",this.title.font="10pt verdana, sans-serif",this.title.x=t,this.title.y=r,this.msg.color=this.title.color,this.msg.font=this.title.font,this.msg.x=t-45,this.msg.y=r+20,Debug.emit(e,"Created screentip at "+t+","+r)}function Score(e,t,r){this.box=new Label(""),this.box.color="rgb(255, 255, 255)",this.box.font="10pt verdana, sans-serif",this.box.x=t,this.box.y=r,this.box.width=500,Debug.emit(e,"Created score counter at "+t+","+r)}function Player(e,t){this.debug=e,this.game=t,this.index=-1,this.pos=225,this.cards=[],this.values=[]}function Dealer(e,t){this.debug=e,this.game=t,this.index=0,this.pos=225,this.cards=[],this.values=[]}function AI(e,t){this.debug=e,this.game=t,this.index=0,this.pos=225,this.cards=[],this.values=[]}var g="graphics/",graphics=[g+"c.png",g+"d.png",g+"cA.png",g+"c2.png",g+"c3.png",g+"c4.png",g+"c5.png",g+"c6.png",g+"c7.png",g+"c8.png",g+"c9.png",g+"c10.png",g+"cJ.png",g+"cQ.png",g+"cK.png",g+"hA.png",g+"h2.png",g+"h3.png",g+"h4.png",g+"h5.png",g+"h6.png",g+"h7.png",g+"h8.png",g+"h9.png",g+"h10.png",g+"hJ.png",g+"hQ.png",g+"hK.png",g+"dA.png",g+"d2.png",g+"d3.png",g+"d4.png",g+"d5.png",g+"d6.png",g+"d7.png",g+"d8.png",g+"d9.png",g+"d10.png",g+"dJ.png",g+"dQ.png",g+"dK.png",g+"sA.png",g+"s2.png",g+"s3.png",g+"s4.png",g+"s5.png",g+"s6.png",g+"s7.png",g+"s8.png",g+"s9.png",g+"s10.png",g+"sJ.png",g+"sQ.png",g+"sK.png"],s="sounds/",sounds=[s+"shuffle.ogg",s+"deal.ogg",s+"reveal.ogg",s+"hit.ogg"],soundOn=!0;SoundEffects.toggle=function(){soundOn=soundOn?!1:!0},SoundEffects.play=function(e,t){soundOn&&(e.sfx?e.assets[s+t+".ogg"].play():new Audio(s+t+".ogg").play())},Debug.emit=function(e,t){e&&console.log(t)},Cards.prototype._getRank=function(){var e=Math.floor(Math.random()*this.ranks.length);return this.ranks[e]},Cards.prototype._getSuit=function(){var e=Math.floor(Math.random()*this.suits.length);return this.suits[e]},Cards.prototype._getCard=function(){return this._getRank()+" "+this._getSuit()},Cards.prototype.shuffle=function(){for(this.index=-1,this.deck=[],this.played=[];;){var e=this._getCard();if(-1==this.deck.indexOf(e)&&(this.deck.push(e),this.deck.length==this.deck_num))break}},Cards.prototype.draw=function(){(this.played.length==this.deck_num||-1==this.index)&&(this.index=0),this.played.push(this.deck[this.index]);var e=this.deck[this.index].split(" ");return"["+e[0]+e[1]+"]"},Cards.prototype.getValue=function(){var e=this.deck[this.index].split(" ");this.index++;var t=0;return t="A"==e[0]?1:"J"==e[0]||"Q"==e[0]||"K"==e[0]?10:parseInt(e[0])},Cards.prototype.getPlayed=function(){return this.played.length},Cards.prototype.drawAll=function(){this.index=0;for(var e=[],t=0;t<this.deck_num;t++){var r=this.draw();e.push(r),this.index++}return this.index=-1,e},Card.getImage=function(e){if("c"==e||"d"==e)return g+e+".png";var t="";new RegExp("(h)").test(e)?t="h":new RegExp("(d)").test(e)?t="d":new RegExp("(c)").test(e)?t="c":new RegExp("(s)").test(e)&&(t="s");var r=e.match(/\[*([0-9A-Z]*)\]*/)[1];return g+t+r+".png"},Card.prototype.getImageSrc=function(){return this.src},Card.prototype.setXY=function(e,t){this.sprite.x=e,this.sprite.y=t},Card.prototype.getXY=function(){return[this.sprite.x,this.sprite.y]},Card.prototype.draw=function(){return this.sprite},Screentip.prototype.emit=function(e,t){this.clear(),this.title.text=e,this.msg.text=t},Screentip.prototype.clear=function(){this.title.text="",this.msg.text=""},Screentip.prototype.draw=function(){return null==this.msg.text&&(this.msg.text=""),null==this.title.text&&(this.title.text=""),[this.title,this.msg]},Score.prototype.emit=function(e){this.clear(),this.box.text=e},Score.prototype.clear=function(){this.box.text=""},Score.prototype.draw=function(){return this.box},Player.prototype.calcTotal=function(){this.values.sort(function(e,t){return t-e});for(var e=0,t=0;t<this.values.length;t++){var r=this.values[t];1==r&&(21>=e+11&&(r=11),e+11>21&&(r=1)),e+=r}return e},Player.prototype.hasBlackjack=function(){var e=!1;return 21==this.calcTotal()&&(Debug.emit(this.debug,"Dealer has Blackjack!"),e=!0),e},Player.prototype.isBust=function(){var e=!1;return this.calcTotal()>21&&(Debug.emit(this.debug,"Dealer is bust!"),e=!0),e},Player.prototype.receiveCards=function(e){for(var t="",r=0;r<e.length;r++){var s=e[r].split(":");this.cards.push(s[0]),this.values.push(parseInt(s[1]))}t=this.cards[0]+this.cards[1],Debug.emit(this.debug,"\nPlayer receives their cards:"),Debug.emit(this.debug,t+" --> "+this.calcTotal().toString()),this.index++;var a=new Card(Card.getImage(this.cards[this.index]),this.pos,310,this.game);this.index++,this.pos+=90;var i=new Card(Card.getImage(this.cards[this.index]),this.pos,310,this.game);return[a,i]},Player.prototype.hit=function(e){var t=e.draw();return this.cards.push(t),this.values.push(parseInt(e.getValue())),this.index++,this.pos+=90,Debug.emit(this.debug,"Player hits."),Debug.emit(this.debug,"Player gets "+t),Debug.emit(this.debug,"Player has "+this.calcTotal().toString()),new Card(Card.getImage(t.match(/\[*([A-Za-z0-9]+)\]*/)[0]),this.pos,310,this.game)},Player.prototype.stand=function(){Debug.emit(this.debug,"Player stands."),Debug.emit(this.debug,"Player has "+this.calcTotal().toString())},Player.prototype.showCards=function(){this.index=0,this.pos=225;for(var e="",t=0;t<this.cards.length;t++)e+=this.cards[t];return Debug.emit(this.debug,"\nPlayer has:"),Debug.emit(this.debug,e+" --> "+this.calcTotal().toString()),this.calcTotal()},Dealer.prototype.calcTotal=function(){this.values.sort(function(e,t){return t-e});for(var e=0,t=0;t<this.values.length;t++){var r=this.values[t];1==r&&(21>=e+11?r=11:e+11>21&&(r=1)),e+=r}return e},Dealer.prototype._hit=function(e){this.index++,this.pos+=90;var t=e.draw();return this.cards.push(t),this.values.push(e.getValue()),Debug.emit(this.debug,"Dealer hits."),Debug.emit(this.debug,"Dealer gets "+t),new Card(Card.getImage(t),this.pos,10,this.game)},Dealer.prototype._stand=function(){Debug.emit(this.debug,"Dealer stands.")},Dealer.prototype.shuffle=function(e){return 0==e.getPlayed()||e.getPlayed()>=45?(SoundEffects.play(this.game,"shuffle"),Debug.emit(this.debug,"-------------------------------------------------------"),Debug.emit(this.debug,"Dealer is shuffling cards..."),Debug.emit(this.debug,"-------------------------------------------------------"),e.shuffle()):void 0},Dealer.prototype.deal=function(e){SoundEffects.play(this.game,"deal");var t=[],r=1;for(Debug.emit(this.debug,"-------------------------------------------------------"),Debug.emit(this.debug,"Dealer is dealing cards for a new game..."),Debug.emit(this.debug,"-------------------------------------------------------");4>=r;)t.push(e.draw()+":"+e.getValue()),r++;for(r=0;2>r;){var s=t[r].split(":");this.cards.push(s[0]),this.values.push(parseInt(s[1])),r++}return Debug.emit(this.debug,"\nDealer has:"),Debug.emit(this.debug,"[**]"+this.cards[1]),[t[2],t[3]]},Dealer.prototype.hasBlackjack=function(){var e=!1;return 21==this.calcTotal()&&(Debug.emit(this.debug,"Dealer has Blackjack!"),e=!0),e},Dealer.prototype.isBust=function(){var e=!1;return this.calcTotal()>21&&(Debug.emit(this.debug,"Dealer is bust!"),e=!0),e},Dealer.prototype.respond=function(e){this.showCards();for(var t=!0,r=[];t;)for(var s=0;18>=s;)if(s=this.calcTotal(),16==s)Math.floor(6*Math.random())>=3?r.push(this._hit(e)):this._stand();else{if(s>=17){this._stand(),t=!1;break}r.push(this._hit(e))}return r},Dealer.prototype.showCards=function(){this.index=0,this.pos=225;for(var e="",t=0;t<this.cards.length;t++)e+=this.cards[t];return Debug.emit(this.debug,"\nDealer has:"),Debug.emit(this.debug,e+" --> "+this.calcTotal().toString()),this.calcTotal()},Dealer.prototype.receiveCards=function(){this.index++;var e=new Card(Card.getImage("c"),this.pos,10,this.game);this.index++,this.pos+=90;var t=new Card(Card.getImage(this.cards[1]),this.pos,10,this.game);return[e,t]},Dealer.prototype.revealFirstCard=function(){return SoundEffects.play(this.game,"reveal"),new Card(Card.getImage(this.cards[0]),225,10,this.game)},AI.prototype.calcTotal=function(){this.values.sort(function(e,t){return t-e});for(var e=0,t=0;t<this.values.length;t++){var r=this.values[t];1==r&&(21>=e+11&&(r=11),e+11>21&&(r=1)),e+=r}return e},AI.prototype.hasBlackjack=function(){var e=!1;return 21==this.calcTotal()&&(Debug.emit(this.debug,"AI has Blackjack!"),e=!0),e},AI.prototype.isBust=function(){var e=!1;return this.calcTotal()>21&&(Debug.emit(this.debug,"AI is bust!"),e=!0),e},AI.prototype.receiveCards=function(e){for(var t="",r=0;r<e.length;r++){var s=e[r].split(":");this.cards.push(s[0]),this.values.push(parseInt(s[1]))}t=this.cards[0]+this.cards[1],Debug.emit(this.debug,"\nAI receives their cards:"),Debug.emit(this.debug,t+" --> "+this.calcTotal().toString()),this.index++;var a=new Card(Card.getImage(this.cards[this.index]),this.pos,310,this.game);this.pos+=90,this.index++;var i=new Card(Card.getImage(this.cards[this.index]),this.pos,310,this.game);return[a,i]},AI.prototype._hit=function(e){var t=e.draw();return this.cards.push(t),this.values.push(e.getValue()),this.index++,this.pos+=90,Debug.emit(this.debug,"AI hits."),Debug.emit(this.debug,"AI gets "+t),Debug.emit(this.debug,"AI has "+this.calcTotal().toString()),new Card(Card.getImage(t.match(/\[*([A-Za-z0-9]+)\]*/)[0]),this.pos,310,this.game)},AI.prototype._stand=function(){Debug.emit(this.debug,"AI stands."),Debug.emit(this.debug,"AI has "+this.calcTotal().toString())},AI.prototype.respond=function(e){this.showCards();for(var t=!0,r=[];t;)for(var s=0;18>=s;)if(s=this.calcTotal(),16==s)Math.floor(6*Math.random())>=3?(this.index++,this.pos+=90,r.push(this._hit(e))):this._stand();else{if(s>=17){this._stand(),t=!1;break}this.index++,this.pos+=90,r.push(this._hit(e))}return r},AI.prototype.showCards=function(){this.index=0,this.pos=225;for(var e="",t=0;t<this.cards.length;t++)e+=this.cards[t];return Debug.emit(this.debug,"\nAI has:"),Debug.emit(this.debug,e+" --> "+this.calcTotal().toString()),this.calcTotal()};var debug=!1,ai=!1,sound=!0,playing=!0,player_index=2,player_cards=[],dealer_index=2,dealer_cards=[],screentip=null,instruction=null,p_score=null,d_score=null,dealer_pile=null,cards=null,player=null,dealer=null,timer=0,SCREEN_WIDTH=780,SCREEN_HEIGHT=500;window.onload=function(){var e=document.getElementById("enchant-stage");e.style.marginLeft="auto",e.style.marginRight="auto",e.style.border="1px dotted rgb(0, 0, 0)",enchant();var t=new Core(SCREEN_WIDTH,SCREEN_HEIGHT),r=graphics.concat(sounds);Debug.emit(debug,"Loading assets:"),Debug.emit(debug,r),t.preload(r),t.onload=function(){function r(){var e=!1,t=navigator.userAgent;return(-1!==t.indexOf("Mobile")||-1!==t.indexOf("Tablet"))&&(e=!0),e}function s(){sound=SoundEffects.toggle()}function a(){var e=!0,t=navigator.userAgent;return-1!==t.indexOf("WebKit")&&(e=!1),e}function i(){playing=!1,dealer_cards[0]=dealer.revealFirstCard();var e=dealer.showCards(),s=player.showCards();21===s&&2===player_index&&21!==e?screentip.emit("PLAYER BLACKJACK!","Player has 21. That's a Blackjack!"):21===e&&2===dealer_index&&21!==s?screentip.emit("DEALER BLACKJACK!","Dealer has 21. That's a Blackjack!"):s==e||s>21&&e>21?screentip.emit("PUSH","Neither dealer nor player won."):21>=s&&s>e?screentip.emit("PLAYER WINS","Player wins with "+s.toString()+". Well done."):21>=e&&e>s?screentip.emit("DEALER WINS","Dealer wins with "+e.toString()+". Too bad."):s>21&&21>=e?screentip.emit("DEALER WINS","Dealer wins. Player bust."):e>21&&21>=s&&screentip.emit("PLAYER WINS","Player wins. Dealer bust."),52==cards.getPlayed()&&(dealer_pile=new Card(Card.getImage("d"),10,10,t)),Debug.emit(debug,"Cards played "+cards.getPlayed().toString()),d_score.emit(dealer.calcTotal()),instruction.emit(r()?"Play again? Long tap screen to continue.":"Play again? Yes [Y key or LMB] or No [N key or Escape key]."),o()}function n(){h(),playing=!0,player_index=2,player_cards=new Array(5),dealer_index=2,dealer_cards=new Array(5),dealer_pile=new Card(Card.getImage("c"),10,10,t),screentip.clear(),player=new Player(debug,t),dealer=new Dealer(debug,t),dealer.shuffle(cards),player_cards=player.receiveCards(dealer.deal(cards)),dealer_cards=dealer.receiveCards(),player_cards[2]=new Card(Card.getImage("d"),405,310,t),player_cards[3]=new Card(Card.getImage("d"),495,310,t),player_cards[4]=new Card(Card.getImage("d"),585,310,t),dealer_cards[2]=new Card(Card.getImage("d"),405,10,t),dealer_cards[3]=new Card(Card.getImage("d"),495,10,t),dealer_cards[4]=new Card(Card.getImage("d"),585,10,t),d(),o()}function d(){toggle_sound.emit("Turn sound on/off [E key]"),(g()||l())&&i(),p_score.emit(player.calcTotal()),playing&&(d_score.emit("?"),instruction.emit("Hit [H key or LMB] or Stand [S key or RMB]?"))}function o(){f.addChild(toggle_sound.draw()),f.addChild(dealer_pile.draw()),f.addChild(screentip.draw()[0]),f.addChild(screentip.draw()[1]),f.addChild(instruction.draw()),f.addChild(p_score.draw()),f.addChild(d_score.draw());for(var e=0;e<player_cards.length;e++)f.addChild(player_cards[e].draw());for(var e=0;e<dealer_cards.length;e++)f.addChild(dealer_cards[e].draw());t.pushScene(f)}function h(){f.removeChild(screentip.draw()[0]),f.removeChild(screentip.draw()[1]),f.removeChild(instruction.draw()),f.removeChild(p_score.draw()),f.removeChild(d_score.draw());for(var e=0;e<player_cards.length;e++)f.removeChild(player_cards[e].draw());for(var e=0;e<dealer_cards.length;e++)f.removeChild(dealer_cards[e].draw())}function g(){var e=!1;return(player.hasBlackjack()||dealer.hasBlackjack())&&(e=!0),e}function l(){var e=!1;return(player.isBust()||dealer.isBust())&&(e=!0),e}function u(){6>player_index&&(SoundEffects.play(t,"hit"),player_cards[player_index]=player.hit(cards),player_index++,d()),o()}function c(){player.stand();for(var e=dealer.respond(cards),t=0;t<e.length;t++){var r=dealer_cards[dealer_index].getXY();dealer_cards[dealer_index]=e[t],dealer_cards[dealer_index].setXY(r[0],r[1]),Debug.emit(debug,"Added image at "+r[0].toString()+","+r[1].toString()),Debug.emit(debug,dealer_index),dealer_index++}i()}function p(){window.location.href="https://github.com/stpettersens/21"}var f=new Scene;f.backgroundColor="rgb(0, 153, 0)",screentip=new Screentip(debug,SCREEN_WIDTH/2-60,190),instruction=new Score(debug,SCREEN_WIDTH/2-200,450),p_score=new Score(debug,153,315),d_score=new Score(debug,153,25),cards=new Cards,t.sfx=a(),toggle_sound=new Score(debug,600,15),n();var y=null;e.addEventListener("touchstart",function(e){e.preventDefault(),y=(new Date).getTime()}),e.addEventListener("touchend",function(e){e.preventDefault();var t=(new Date).getTime()-y;600>t&&t>0&&(playing?u():playing?c():n())}),e.addEventListener("mousedown",function(e){playing&&1===e.which?u():playing&&3===e.which?c():playing||1!==e.which||n()}),e.addEventListener("contextmenu",function(e){e.preventDefault()},!1),document.addEventListener("keydown",function(e){playing&&72===e.keyCode?u():playing&&83===e.keyCode?c():playing||89!==e.keyCode?playing||78!==e.keyCode?27===e.keyCode?p():69==e.keyCode&&s():p():n()})},Debug.emit(debug,"Initialized HTML5 Blackjack (enchant.js build)."),t.start()};