/*
Blackjack (CoffeeScript build).
Copyright 2015 Sam Saint-Pettersen
Released under the MIT/X11 License.
https://github.com/stpettersens/21
*/
var AI,Card,Cards,Dealer,Debug,Player,SCREEN_HEIGHT,SCREEN_WIDTH,Score,Screentip,canvas,cards,d_score,dealer,dealer_cards,dealer_index,dealer_pile,debug,instruction,p_score,player,player_cards,player_index,playing,screentip,sound,start,timer,toggle_sound,use_ai;Cards=function(){function e(){this.index=-1,this.deck_num=52,this.deck=[],this.played=[],this.ranks=["A","2","3","4","5","6","7","8","9","10","J","Q","K"],this.suits=["h","d","c","s"]}return e.prototype._getRank=function(){var e;return e=Math.floor(Math.random()*this.ranks.length),this.ranks[e]},e.prototype._getSuit=function(){var e;return e=Math.floor(Math.random()*this.suits.length),this.suits[e]},e.prototype._getCard=function(){return this._getRank()+" "+this._getSuit()},e.prototype.shuffle=function(){var e,t;for(this.index=-1,this.deck=[],this.played=[],t=[];;)if(e=this._getCard(),-1===this.deck.indexOf(e)){if(this.deck.push(e),this.deck.length===this.deck_num)break;t.push(void 0)}else t.push(void 0);return t},e.prototype.draw=function(){var e;return(this.played.length===this.deck_num||-1===this.index)&&(this.index=0),this.played.push(this.deck[this.index]),e=this.deck[this.index].split(" "),"["+e[0]+e[1]+"]"},e.prototype.getValue=function(){var e,t;return e=this.deck[this.index].split(" "),this.index++,t=0,t="A"===e[0]?1:"J"===e[0]||"Q"===e[0]||"K"===e[0]?10:parseInt(e[0])},e.prototype.getPlayed=function(){return this.played.length},e.prototype.drawAll=function(){var e,t;for(this.index=0,e=[],t=0;t<this.deck_num;)e.push(this.draw()),this.index++,t++;return this.index=-1,e},e}(),Card=function(){function e(e,t,a){this.image=new Image,this.image.src=e,this.posX=t,this.posY=a}return e.getImage=function(e){var t,a;return"c"===e||"d"===e?"gfx/"+e+".png":(a="",/(h)/.test(e)?a="h":/(d)/.test(e)?a="d":/(c)/.test(e)?a="c":/(s)/.test(e)&&(a="s"),t=e.match(/\[*([0-9A-Z]*)\]*/)[1],"gfx/"+a+t+".png")},e.getImageData=function(t){return graphics[gfx_fns.indexOf(e.getImage(t))]},e.prototype.getImageSrc=function(){return this.image.src},e.prototype.setXY=function(e,t){return this.posX=e,this.posY=t},e.prototype.getXY=function(){return[this.posX,this.posY]},e.prototype.draw=function(){var e,t;return e=document.getElementById("blackjack-table"),t=e.getContext("2d"),t.drawImage(this.image,this.posX,this.posY,this.image.width,this.image.height)},e}(),Player=function(){function e(e){this.debug=e,this.index=-1,this.pos=225,this.cards=[],this.values=[]}return e.prototype.calcTotal=function(){var e,t,a;for(this.values.sort(function(e,t){return t-e}),t=0,e=0;e<this.values.length;)a=this.values[e],1===a&&(21>=t+11&&(a=11),t+11>21&&(a=1)),t+=a,e++;return t},e.prototype.hasBlackjack=function(){var e;return e=!1,21===this.calcTotal()&&(Debug.emit(this.debug,"Dealer has Blackjack!"),e=!0),e},e.prototype.isBust=function(){var e;return e=!1,this.calcTotal()>21&&(Debug.emit(this.debug,"Dealer is bust!"),e=!0),e},e.prototype.receiveCards=function(e){var t,a,s,r,i;for(i="",r=0;r<e.length;)s=e[r].split(":"),this.cards.push(s[0]),this.values.push(parseInt(s[1])),r++;return i=this.cards[0]+this.cards[1],Debug.emit(this.debug,"\nPlayer receives their cards:"),Debug.emit(this.debug,i+" --> "+this.calcTotal()),this.index++,t=new Card(Card.getImageData(this.cards[this.index]),this.pos,310),this.pos+=90,this.index++,a=new Card(Card.getImageData(this.cards[this.index]),this.pos,310),[t,a]},e.prototype.hit=function(e){var t;return t=e.draw(),this.cards.push(t),this.values.push(e.getValue()),this.index++,this.pos+=90,Debug.emit(this.debug,"Player hits."),Debug.emit(this.debug,"Player gets "+t),Debug.emit(this.debug,"Player has "+this.calcTotal()),new Card(Card.getImageData(t.match(/\[*([A-Za-z0-9]+)\]*/)[0]),this.pos,310)},e.prototype.stand=function(){return Debug.emit(this.debug,"Player stands."),Debug.emit(this.debug,"Player has "+this.calcTotal())},e.prototype.showCards=function(){var e,t;for(this.index=0,this.pos=225,t=0;t<this.cards.length;)e=this.cards[t],t++;return Debug.emit(this.debug,"\nPlayer has:"),Debug.emit(this.debug,e+" --> "+this.calcTotal()),this.calcTotal()},e}(),Dealer=function(){function e(e){this.debug=e,this.index=0,this.pos=225,this.cards=[],this.values=[]}return e.prototype.calcTotal=function(){var e,t,a;for(this.values.sort(function(e,t){return t-e}),t=0,e=0;e<this.values.length;)a=this.values[e],1===a&&(21>=t+11&&(a=11),t+11>21&&(a=1)),t+=a,e++;return t},e.prototype._hit=function(e){var t;return this.index++,this.pos+=90,t=e.draw(),this.cards.push(t),this.values.push(e.getValue()),Debug.emit(this.debug,"Dealer hits."),Debug.emit(this.debug,"Dealer gets "+t),new Card(Card.getImageData(t),this.pos,10)},e.prototype._stand=function(){return Debug.emit(this.debug,"Dealer stands.")},e.prototype.shuffle=function(e){return 0===e.getPlayed()||e.getPlayed()>=45?(SoundEffects.play("shuffle"),Debug.emit(this.debug,"-------------------------------------------------------"),Debug.emit(this.debug,"Dealer is shuffling cards..."),Debug.emit(this.debug,"-------------------------------------------------------"),e.shuffle()):void 0},e.prototype.deal=function(e){var t,a,s;for(SoundEffects.play("deal"),a=[],s=1,Debug.emit(this.debug,"-------------------------------------------------------"),Debug.emit(this.debug,"Dealer is dealing cards for a new game..."),Debug.emit(this.debug,"-------------------------------------------------------");4>=s;)a.push(e.draw()+":"+e.getValue()),s++;for(s=0;2>s;)t=a[s].split(":"),this.cards.push(t[0]),this.values.push(parseInt(t[1])),s++;return Debug.emit(this.debug,"\nDealer has:"),Debug.emit(this.debug,"[**]"+this.cards[1]),[a[2],a[3]]},e.prototype.hasBlackjack=function(){var e;return e=!1,21===this.calcTotal()&&(Debug.emit(this.debug,"Dealer has Blackjack!"),e=!0),e},e.prototype.isBust=function(){var e;return e=!1,this.calcTotal()>21&&(Debug.emit(this.debug,"Dealer is bust!"),e=!0),e},e.prototype.respond=function(e){var t,a,s;for(this.showCards(),t=!0,a=[];t;)for(s=0;18>=s;)if(s=this.calcTotal(),16===s)Math.floor(6*Math.random())>=3?a.push(this._hit(e)):this._stand();else{if(s>=17){this._stand(),t=!1;break}a.push(this._hit(e))}return a},e.prototype.showCards=function(){var e,t;for(this.index=0,this.pos=225,e="",t=0;t<this.cards.length;)e+=this.cards[t],t++;return Debug.emit(this.debug,"\nDealer has:"),Debug.emit(this.debug,e+" --> "+this.calcTotal()),this.calcTotal()},e.prototype.receiveCards=function(){var e,t;return e=new Card(Card.getImageData("c"),this.pos,10),this.pos+=90,t=new Card(Card.getImageData(this.cards[1]),this.pos,10),this.index+=2,[e,t]},e.prototype.revealFirstCard=function(){return SoundEffects.play("reveal"),new Card(Card.getImageData(this.cards[0]),225,10)},e}(),AI=function(){function e(e){this.debug=e,this.index=0,this.pos=255,this.cards=[],this.values=[]}return e.prototype.calcTotal=function(){var e,t,a;for(this.values.sort(function(e,t){return t-e}),t=0,e=0;e<this.values.length;)a=this.values[e],1===a&&(21>=t+11&&(a=11),t+11>21&&(a=1),t+=a,e++);return t},e.prototype.hasBlackjack=function(){var e;return e=!1,21===this.calcTotal()&&(Debug.emit(this.debug,"AI has Blackjack!"),e=!0),e},e.prototype.isBust=function(){var e;return e=!1,this.calcTotal()>21&&(Debug.emit(this.debug,"AI is bust!"),e=!0),e},e.prototype.receiveCards=function(e){var t,a,s,r,i;for(t="",i=0;i<e.length;)r=e[i].split(":"),this.cards.push(r[0]),this.values.push(parseInt(r[1])),i++;return t=this.cards[0]+this.cards[1],Debug.emit(this.debug,"\nAI receives their cards:"),Debug.emit(this.debug,t+" --> "+this.calcTotal()),this.index++,a=new Card(Card.getImageData(this.cards[this.index]),this.pos,310),this.pos+=90,this.index++,s=new Card(Card.getImageData(this.cards[this.index]),this.pos,310),[a,s]},e.prototype._hit=function(e){var t;return t=e.draw(),this.cards.push(t),this.values.push(e.getValue()),this.index++,this.pos+=90,Debug.emit(this.debug,"AI hits."),Debug.emit(this.debug,"AI gets "+t),Debug.emit(this.debug,"AI has "+this.calcTotal()),new Card(Card.getImageData(t.match(/\[*([A-Za-z0-9]+)\]*/)[0]),this.pos,310)},e.prototype._stand=function(){return Debug.emit(this.debug,"AI stands."),Debug.emit(this.debug,"AI has "+this.calcTotal())},e.prototype.respond=function(e){var t,a,s;for(this.showCards(),t=!0,a=[];t;)for(s=0;18>=s;)if(s=this.calcTotal(),16===s)Math.floor(6*Math.random())>=3?(this.index++,this.pos+=90,a.push(this._hit(e))):this._stand();else{if(s>=17){this._stand(),t=!1;break}this.index++,this.pos+=90,a.push(this._hit(e))}return a},e.prototype.showCards=function(){var e,t;for(this.index=0,this.pos=225,e="",t=0;t<this.cards.length;)e+=this.cards[t],t++;return Debug.emit(this.debug,"\nAI has:"),Debug.emit(this.debug,e+" --> "+this.calcTotal()),this.calcTotal()},e}(),Screentip=function(){function e(e,t,a){this.debug=e,this.posX=t,this.posY=a,this.title="",this.msg="",Debug.emit(this.debug,"Created screentip at "+t+","+a)}return e.prototype.emit=function(e,t){return this.clear(),this.title=e,this.msg=t},e.prototype.clear=function(){return this.title="",this.msg=""},e.prototype.draw=function(){var e,t;return null===this.msg&&(this.msg=""),null===this.title&&(this.title=""),e=document.getElementById("blackjack-table"),t=e.getContext("2d"),t.font="10pt Verdana",t.fillStyle="white",t.fillText(this.title,this.posX,this.posY),t.fillText(this.msg,this.posX-45,this.posY+20)},e}(),Score=function(){function e(e,t,a){this.debug=e,this.posX=t,this.posY=a,this.score="",Debug.emit(this.debug,"Created score counter at "+t+","+a)}return e.prototype.emit=function(e){return this.clear(),this.score=e},e.prototype.clear=function(){return this.score=""},e.prototype.draw=function(){var e,t;return e=document.getElementById("blackjack-table"),t=e.getContext("2d"),t.font="10pt Verdana",t.fillStyle="white",t.fillText(this.score,this.posX,this.posY)},e}(),Debug=function(){function e(){}return e.emit=function(e,t){return e?console.log(t):void 0},e}(),debug=!1,use_ai=!1,sound=!0,playing=!0,player_index=2,player_cards=[],dealer_index=2,dealer_cards=[],screentip=null,instruction=null,p_score=null,d_score=null,dealer_pile=null,cards=null,player=null,dealer=null,canvas=null,toggle_sound=null,timer=0,SCREEN_WIDTH=780,SCREEN_HEIGHT=500,this.init=function(){return Debug.emit(debug,"Initialized HTML5 Blackjack (CoffeeScript build)."),canvas=document.getElementById("blackjack-table"),canvas.width=""+SCREEN_WIDTH,canvas.height=""+SCREEN_HEIGHT,canvas.style.backgroundColor="rgb(0, 153, 0)",canvas.style.marginLeft="auto",canvas.style.marginRight="auto",canvas.style.display="block",canvas.style.border="1px dotted rgb(0, 0, 0)",screentip=new Screentip(debug,SCREEN_WIDTH/2-50,190),instruction=new Score(debug,SCREEN_WIDTH/2-155,450),p_score=new Score(debug,153,315),d_score=new Score(debug,153,25),cards=new Cards,toggle_sound=new Score(debug,600,15),newGame()},this.isTouchScreenDevice=function(){var e,t;return e=!1,t=navigator.userAgent,(-1!==t.indexOf("Mobile")||-1!==t.indexOf("Tablet"))&&(e=!0),e},this.toggleSound=function(){return sound=SoundEffects.toggle(),update()},this.showCards=function(){var e,t;return playing=!1,dealer_cards[0]=dealer.revealFirstCard(),e=dealer.showCards(),t=player.showCards(),21===t&&2===player_index&&21!==e?screentip.emit("PLAYER BLACKJACK!","Player has 21. That's a Blackjack!"):21===e&&2===dealer_index&&21!==t?screentip.emit("DEALER BLACKJACK!","Dealer has 21. That's a Blackjack!"):t===e||t>21&&e>21?screentip.emit("PUSH","Neither dealer nor player won."):21>=t&&t>e?screentip.emit("PLAYER WINS","Player wins with "+t+". Well done."):21>=e&&e>t?screentip.emit("DEALER WINS","Dealer wins with "+e+". Too bad."):t>21&&21>=e?screentip.emit("DEALER WINS","Dealer wins. Player bust."):e>21&&21>=t&&screentip.emit("PLAYER WINS","Player wins. Dealer bust."),52===cards.getPlayed()&&(dealer_pile=new Card(Card_getImage("d"),10,10)),Debug.emit(debug,"Cards played "+cards.getPlayed()),d_score.emit(dealer.calcTotal()),instruction.emit(isTouchScreenDevice()?"Play again? Long tap screen to continue.":"Play again? Yes [Y key or LMB] or No [N key or Escape key]."),draw()},this.newGame=function(){return clear(),playing=!0,player_index=2,player_cards=[],dealer_index=2,dealer_cards=[],dealer_pile=new Card(Card.getImageData("c"),10,10),screentip.clear(),player=new Player(debug),dealer=new Dealer(debug),dealer.shuffle(cards),player_cards=player.receiveCards(dealer.deal(cards)),dealer_cards=dealer.receiveCards(),player_cards[2]=new Card(Card.getImageData("d"),405,310),player_cards[3]=new Card(Card.getImageData("d"),495,310),player_cards[4]=new Card(Card.getImageData("d"),585,310),dealer_cards[2]=new Card(Card.getImageData("d"),405,10),dealer_cards[3]=new Card(Card.getImageData("d"),495,10),dealer_cards[4]=new Card(Card.getImageData("d"),585,10),update(),draw()},this.update=function(){return toggle_sound.clear(),toggle_sound.emit(sound?"Turn sound off [E key]":"Turn sound on [E key]"),(hasBlackjack()||isBust())&&showCards(),p_score.emit(player.calcTotal()),playing?(d_score.emit("?"),instruction.emit(isTouchScreenDevice()?"Hit [Short tap] or Stand [Long tap]?":"Hit [H key or LMB] or Stand [S key or RMB]?")):void 0},this.draw=function(){var e,t;for(clear(),toggle_sound.draw(),dealer_pile.draw(),screentip.draw(),instruction.draw(),p_score.draw(),d_score.draw(),e=0;e<player_cards.length;)player_cards[e].draw(),e++;for(e=0,t=[];e<dealer_cards.length;)dealer_cards[e].draw(),t.push(e++);return t},this.hasBlackjack=function(){var e;return e=!1,(player.hasBlackjack()||dealer.hasBlackjack())&&(e=!0),e},this.isBust=function(){var e;return e=!1,(player.isBust()||dealer.isBust())&&(e=!0),e},this.hit=function(){return 6>player_index&&(SoundEffects.play("hit"),player_cards[player_index]=player.hit(cards),player_index++,update()),draw()},this.stand=function(){var e,t,a;for(player.stand(),t=dealer.respond(cards),e=0;e<t.length;)a=dealer_cards[dealer_index].getXY(),dealer_cards[dealer_index]=t[e],dealer_cards[dealer_index].setXY(a[0],a[1]),Debug.emit(debug,"Added image at "+a[0]+","+a[1]),Debug.emit(debug,dealer_index),dealer_index++,e++;return showCards()},this.clear=function(){var e;return e=canvas.getContext("2d"),e.clearRect(0,0,canvas.width,canvas.height)},this.exitToGithub=function(){return window.location.href="https:github.com/stpettersens/21"},start=null,document.addEventListener("touchstart",function(e){return e.preventDefault(),start=(new Date).getTime()}),document.addEventListener("touchend",function(e){var t;return e.preventDefault(),t=(new Date).getTime()-start,600>t&&t>0?playing?hit():void 0:playing?stand():newGame()}),document.addEventListener("mousedown",function(e){return playing&&1===e.which?hit():playing&&3===e.which?stand():playing||1!==e.which?void 0:newGame()}),document.addEventListener("contextmenu",function(e){return e.preventDefault()}),document.addEventListener("keydown",function(e){return playing&&72===e.keyCode?hit():playing&&83===e.keyCode?stand():playing||89!==e.keyCode?playing||78!==e.keyCode?27===e.keyCode?exitToGithub():69===e.keyCode?toggleSound():void 0:exitToGithub():newGame()});